apiVersion: v1
kind: Namespace
metadata:
  name: harbor
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: harbor
  namespace: harbor
spec:
  interval: 5m
  url: https://helm.goharbor.io
---
apiVersion: v1
kind: Secret
metadata:
  name: secret-key
  namespace: harbor
type: Opaque
data:
  secretKey: ENC[AES256_GCM,data:rKiFTgmAxmmKw1EncKqONw==,iv:1TrjNtfHraul+jmb8tePbLpukqzx1fdAXB1G4Vd3yIA=,tag:E1jALc7PPs4F4sg1j6FXOQ==,type:str]
sops:
  age:
  - recipient: age1wpk6a50fj9hepmve43dtx36fr6rfat6nsms6fx6rf4x2udmmtutsmtzctr
    enc: |
      -----BEGIN AGE ENCRYPTED FILE-----
      YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB3TFBlL0g0NjQyVUUwMnp6
      ME1QeE9DZkVIWFNFUVQwKzhCOW5BVHE0eG5rClplQXhCenh0eVRlOERlUmJLdDJ1
      djdDT0tIc2JzdDY3UjZDMkdiaEZoVTAKLS0tIER6aGJYTzVZZFhjTjY5ck5MdER6
      RnNIV21ZNGNReGxUNkY1cXBJR1pmbnMKHBUthNuY3Vi8AwhfZUW4W9zeTelqiP1q
      syr847bsAkn3u/KEaFUcYmPlDaSGAxOzrQNl3o937ZQ4n/aC29uQhg==
      -----END AGE ENCRYPTED FILE-----
  mac: ENC[AES256_GCM,data:GyCMQlKMNi+HtccI1vtw0PBuaPVqZ9IQVdaktzyt43ZfATiTflfDCv/otKt8jRJBt0Sxh0jnYIDYDg2d3C6PR4c4UKEgJ9VQJTK2lTisFGa08fNjBT3xsGAeZL3uJamemHhg+CL6SRD7rZQ6Dgxngl6XjuQ3VFWJkMT+8H0djVA=,iv:SlG5FdOgQaHtgXhRZf3vRsNCqXtPUmcmKqz5STfJZLI=,tag:PmrbmyygMA2Dw0rxnzCvoQ==,type:str]
  lastmodified: "2024-01-01T13:19:56Z"
  encrypted_regex: ^(data|stringData)$
  version: 3.8.1
---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: harbor
  namespace: harbor
spec:
  chart:
    spec:
      chart: harbor
      version: 1.13.1
      sourceRef:
        kind: HelmRepository
        name: harbor
  interval: 50m
  install:
    remediation:
      retries: 3
  values:
    # https://raw.githubusercontent.com/goharbor/harbor-helm/v1.13.1/values.yaml
    expose:
      type: ingress
      tls:
        enabled: true
        certSource: secret
        secret:
          secretName: harbor-tls
          notarySecretName: notary-tls
      ingress:
        hosts:
          core: registry.boo.eth0.work
        controller: default
        className: haproxy
        annotations:
          ingress.kubernetes.io/ssl-redirect: "true"
        harbor:
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt

    externalURL: https://registry.boo.eth0.work

    internalTLS:
      enabled: false

    ipFamily:
      ipv6:
        enabled: false

    persistence:
      enabled: true
      resourcePolicy: "keep"
      persistentVolumeClaim:
        registry:
          storageClass: nfs-storage
        chartmuseum:
          storageClass: nfs-storage
        jobservice:
          storageClass: nfs-storage
        database:
          storageClass: nfs-storage
        redis:
          storageClass: nfs-storage
        trivy:
          storageClass: nfs-storage

    imagePullPolicy: IfNotPresent

    # Senha inicial. Alterar depois de instalar
    harborAdminPassword: "Harbor12345"

    existingSecretSecretKey: secret-key

    chartmuseum:
      enabled: false

    trivy:
      enabled: false

    notary:
      enabled: false

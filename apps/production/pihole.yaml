---
apiVersion: v1
kind: Namespace
metadata:
  name: pihole
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: pihole
  namespace: pihole
spec:
  interval: 5m
  url: https://mojo2600.github.io/pihole-kubernetes/
---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: pihole
  namespace: pihole
spec:
  chart:
    spec:
      chart: pihole
      sourceRef:
        kind: HelmRepository
        name: pihole
  interval: 50m
  install:
    remediation:
      retries: 3
  values:
    serviceDns:
      mixedService: true
      type: LoadBalancer
      loadBalancerIP: 192.168.10.70
      annotations:
        metallb.universe.tf/allow-shared-ip: "10.70"
      externalTrafficPolicy: Cluster

    serviceDhcp:
      enabled: false

    virtualHost: pi.boo.eth0.work

    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
      hosts:
      - pi.boo.eth0.work
      tls:
      - secretName: pi-le-cert
        hosts:
        - pi.boo.eth0.work

    persistentVolumeClaim:
      enabled: true
      storageClass: nfs-storage

    adminPassword: "admin"

    extraEnvVars:
      TZ: America/Sao_Paulo

    DNS1: "1.1.1.1"
    DNS2: "1.0.0.1"

    podDnsConfig:
      enabled: false

    dnsmasq:
      customSettings:
        minTTL: # nome dessa chave é livre
          min-cache-ttl=3600 # 1h é o valor máximo permitido pelo dnsmasq

---
apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-apikey-secreta
  namespace: cert-manager
data:
  apikey: ENC[AES256_GCM,data:KOkq3XFnbGoYp/udLKl3Q6e6+pQyaV3pak1iks3/bW3BD9lRxmQLytgr+j6TzEwxeazLYjiYgDA=,iv:o07Bjn6DzQuhPT1FMYcQv/ahGPyzDW/xDfOkE8Grczg=,tag:dUCuGn/re4AvQRfrJ1jVaQ==,type:str]
type: Opaque
sops:
  kms: []
  gcp_kms: []
  azure_kv: []
  hc_vault: []
  age:
  - recipient: age1wpk6a50fj9hepmve43dtx36fr6rfat6nsms6fx6rf4x2udmmtutsmtzctr
    enc: |
      -----BEGIN AGE ENCRYPTED FILE-----
      YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBWQmI0bUp1SEFIZWdWTmpn
      dUdjaElWOGNmaXMzbkxQRStNR2syWWdZVkJnCjZoRVB0eTZEYnB6ZElYL1hseFNL
      L1JWMlowWWNMOFNNaFhxWDg1OFRJdHMKLS0tIEd5UmZadVp1M3RpTkttZ3E2b1V0
      NmJNcUlqeWpwVXFPYUhxb0lYM1o5MkEKhaA0s6RV1Oj07LjOEYd347W7QpZ70mpr
      SNDfXycRmge3stlLvHFqXNDpstOUVn8MD9QzW8dEchLKnfSk62dbkw==
      -----END AGE ENCRYPTED FILE-----
  lastmodified: "2023-12-25T21:53:15Z"
  mac: ENC[AES256_GCM,data:GuwXg7VwoqkH/CBPGs3qc/yYALMCNG9E6r6kXeLkAq381wqKtfsuXyV9mSbc8QfNM+ZpLsuURuXY9MXVGceLUD6PoDiKEhKwyo2ZcaRIlPdfM2O1DjqRgz3UPG2tenhdnfr6DcmixAS4O2IOA36CPZpKBwePVIIEDKBtV/scsoY=,iv:aad1xmiuf7zCgbs/oLUUfdMh6kuuMSOwj57HSj37Zu4=,tag:ZHJaHqNLoWkSLN5tjaUUyg==,type:str]
  pgp: []
  encrypted_regex: ^(data|stringData)$
  version: 3.8.1
---
apiVersion: v1
kind: Namespace
metadata:
  name: pihole
---
apiVersion: v1
kind: Secret
metadata:
  name: pihole-secret
  namespace: pihole
data:
  password: cGhvZWxlcGFzc3dvcmQ=
type: Opaque
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: pihole
  namespace: pihole
spec:
  interval: 5m
  url: https://mojo2600.github.io/pihole-kubernetes/
---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: pihole
  namespace: pihole
spec:
  chart:
    spec:
      chart: pihole
      sourceRef:
        kind: HelmRepository
        name: pihole
  interval: 50m
  install:
    remediation:
      retries: 3
  values:
    serviceDns:
      mixedService: true
      type: LoadBalancer
      loadBalancerIP: 192.168.10.70
      annotations:
        metallb.universe.tf/allow-shared-ip: "10.70"
      externalTrafficPolicy: Cluster

    serviceDhcp:
      enabled: false

    virtualHost: pi.boo.eth0.work

    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
      hosts:
      - pi.boo.eth0.work
      tls:
      - secretName: pi-le-cert
        hosts:
        - pi.boo.eth0.work

    persistentVolumeClaim:
      enabled: true
      storageClass: nfs-storage

    admin:
      existingSecret: pihole-secret

    extraEnvVars:
      TZ: America/Sao_Paulo

    DNS1: "1.1.1.1"
    DNS2: "1.0.0.1"

    podDnsConfig:
      enabled: false

    dnsmasq:
      customSettings:
        minTTL: # nome dessa chave é livre
          min-cache-ttl=3600 # 1h é o valor máximo permitido pelo dnsmasq
